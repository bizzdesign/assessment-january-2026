<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assessment API Tester</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; }
    h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
    h2 { margin-top: 30px; }
    h3 { margin: 10px 0; font-size: 14px; color: #555; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; font-family: monospace; }
    textarea { height: 120px; resize: vertical; }
    button { margin-top: 10px; padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; margin-right: 10px; }
    button:hover { background: #555; }
    .result { margin-top: 10px; padding: 12px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; overflow-x: auto; max-height: 300px; overflow-y: auto; }
    .error { background: #fee; color: #c00; }
    .success { background: #efe; }
    hr { margin: 40px 0; border: none; border-top: 2px solid #ddd; }
    .row { display: flex; gap: 15px; }
    .row > * { flex: 1; }
    .col { display: flex; flex-direction: column; }
    
    /* Comparison layout */
    .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
    .comparison-panel { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fafafa; }
    .comparison-panel h3 { margin-top: 0; padding-bottom: 8px; border-bottom: 1px solid #ddd; }
    .record-card { background: white; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; margin-bottom: 10px; font-family: monospace; font-size: 11px; }
    .record-card:last-child { margin-bottom: 0; }
    .record-card .id { font-weight: bold; color: #333; margin-bottom: 5px; }
    .record-card .field { display: flex; margin: 2px 0; }
    .record-card .field-name { color: #666; min-width: 120px; }
    .record-card .field-value { color: #000; }
    .record-card .arrow { color: #999; margin: 0 8px; }
    .record-card.success { border-left: 3px solid #4a4; }
    .record-card.error { border-left: 3px solid #a44; }
    .meta { font-size: 10px; color: #888; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd; }
    
    .summary-bar { background: #333; color: white; padding: 10px 15px; border-radius: 4px; margin-bottom: 15px; display: flex; justify-content: space-between; }
    .summary-bar .stat { text-align: center; }
    .summary-bar .stat-value { font-size: 20px; font-weight: bold; }
    .summary-bar .stat-label { font-size: 11px; opacity: 0.8; }
  </style>
</head>
<body>
  <h1>Assessment API Tester</h1>

  <h2>1. Generate Mapping Config</h2>
  <p>Upload a source file and generate a mapping configuration using the LLM.</p>
  
  <div class="row">
    <div>
      <label>Load Sample File:</label>
      <select id="sampleFileSelect" onchange="loadSampleFile()">
        <option value="">-- Select a sample file --</option>
        <option value="users.csv">users.csv (CSV → users)</option>
        <option value="products.json">products.json (JSON → products)</option>
        <option value="orders.csv">orders.csv (CSV → orders)</option>
        <option value="inventory.json">inventory.json (JSON → products)</option>
      </select>
    </div>
    <div>
      <label>File Type:</label>
      <select id="generateFileType">
        <option value="csv">CSV</option>
        <option value="json">JSON</option>
      </select>
    </div>
    <div>
      <label>Target Repository:</label>
      <select id="generateTargetRepo">
        <option value="users">users</option>
        <option value="products">products</option>
        <option value="orders">orders</option>
      </select>
    </div>
  </div>

  <label>Source File Content:</label>
  <textarea id="generateSourceFile" placeholder="Paste your CSV or JSON file content here..."></textarea>
  
  <button onclick="generateConfig()">Generate Config</button>
  <button onclick="copyConfigToExecute()">Copy Config to Execute ↓</button>
  
  <div class="row" style="margin-top: 15px;">
    <div>
      <h3>Generated Config</h3>
      <div id="generateResult" class="result">Response will appear here...</div>
    </div>
    <div>
      <h3>Detected Source Fields</h3>
      <div id="sourceFieldsResult" class="result">Fields will appear here...</div>
    </div>
  </div>

  <hr>

  <h2>2. Execute Mapping</h2>
  <p>Execute a mapping configuration against a source file to produce standardized output.</p>

  <div class="row">
    <div>
      <label>Mapping Config (JSON):</label>
      <textarea id="executeConfig" style="height: 180px;">{
  "name": "user-import",
  "sourceType": "csv",
  "targetRepository": "users",
  "idField": "user_id",
  "fieldMappings": [
    { "sourceField": "email_address", "targetField": "email" },
    { "sourceField": "full_name", "targetField": "name", "transform": "trim" },
    { "sourceField": "phone_number", "targetField": "phone" },
    { "sourceField": "role", "targetField": "role" }
  ],
  "options": { "skipEmptyFields": true, "validateRequired": true }
}</textarea>
    </div>
    <div>
      <label>Source File Content:</label>
      <textarea id="executeSourceFile" style="height: 180px;" placeholder="Paste your CSV or JSON file content here..."></textarea>
    </div>
  </div>

  <button onclick="executeConfig()">Execute Config</button>
  <button onclick="toggleRawView()">Toggle Raw JSON</button>

  <div id="executeResultContainer">
    <div id="summaryBar" class="summary-bar" style="display: none;">
      <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Records</div></div>
      <div class="stat"><div class="stat-value" id="statSuccess">0</div><div class="stat-label">Successful</div></div>
      <div class="stat"><div class="stat-value" id="statFailed">0</div><div class="stat-label">Failed</div></div>
      <div class="stat"><div class="stat-value" id="statRepo">-</div><div class="stat-label">Repository</div></div>
    </div>
    
    <div id="comparisonView" class="comparison" style="display: none;">
      <div class="comparison-panel">
        <h3>Source Records (Input)</h3>
        <div id="inputRecords"></div>
      </div>
      <div class="comparison-panel">
        <h3>Standardized Records (Output)</h3>
        <div id="outputRecords"></div>
      </div>
    </div>
    
    <div id="executeResultRaw" class="result" style="display: none;">Response will appear here...</div>
    <div id="executeResultError" class="result error" style="display: none;"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    let lastExecuteResult = null;
    let showRawView = false;

    const SAMPLE_FILES = {
      'users.csv': `user_id,email_address,full_name,phone_number,role
1,alice@example.com,Alice Smith,555-1234,admin
2,bob@example.com,Bob Jones,,user
3,charlie@example.com,Charlie Brown,555-5678,user
4,diana@example.com,Diana Prince,555-9999,moderator`,
      'products.json': `[
  { "product_code": "SKU001", "product_name": "Widget", "unit_price": "29.99", "desc": "A useful widget", "qty": "100", "cat": "tools" },
  { "product_code": "SKU002", "product_name": "Gadget", "unit_price": "49.99", "desc": "A cool gadget", "qty": "50", "cat": "electronics" },
  { "product_code": "SKU003", "product_name": "Thingamajig", "unit_price": "19.99", "desc": "", "qty": "200", "cat": "misc" },
  { "product_code": "SKU004", "product_name": "Doohickey", "unit_price": "9.99", "desc": "Essential doohickey", "qty": "500", "cat": "tools" }
]`,
      'orders.csv': `order_ref,cust_id,amount,state,created
ORD-001,1,79.98,shipped,2026-01-15
ORD-002,2,29.99,pending,2026-01-20
ORD-003,1,149.97,delivered,2026-01-10
ORD-004,3,59.99,processing,2026-01-25
ORD-005,4,199.99,shipped,2026-01-22`,
      'inventory.json': `{
  "warehouse": "WEST-01",
  "lastUpdated": "2026-01-28",
  "items": [
    { "sku": "SKU001", "name": "Widget", "onHand": 85, "reorderPoint": 20, "unitCost": 15.00 },
    { "sku": "SKU002", "name": "Gadget", "onHand": 42, "reorderPoint": 10, "unitCost": 25.00 },
    { "sku": "SKU003", "name": "Thingamajig", "onHand": 180, "reorderPoint": 50, "unitCost": 8.00 },
    { "sku": "SKU004", "name": "Doohickey", "onHand": 450, "reorderPoint": 100, "unitCost": 4.00 }
  ]
}`
    };

    const FILE_MAPPINGS = {
      'users.csv': { fileType: 'csv', targetRepo: 'users' },
      'products.json': { fileType: 'json', targetRepo: 'products' },
      'orders.csv': { fileType: 'csv', targetRepo: 'orders' },
      'inventory.json': { fileType: 'json', targetRepo: 'products' }
    };

    function loadSampleFile() {
      const select = document.getElementById('sampleFileSelect');
      const fileName = select.value;
      if (fileName && SAMPLE_FILES[fileName]) {
        document.getElementById('generateSourceFile').value = SAMPLE_FILES[fileName];
        document.getElementById('executeSourceFile').value = SAMPLE_FILES[fileName];
        
        const mapping = FILE_MAPPINGS[fileName];
        document.getElementById('generateFileType').value = mapping.fileType;
        document.getElementById('generateTargetRepo').value = mapping.targetRepo;
      }
    }

    function copyConfigToExecute() {
      const result = document.getElementById('generateResult').textContent;
      try {
        const data = JSON.parse(result);
        if (data.config && !data.config._placeholder) {
          document.getElementById('executeConfig').value = JSON.stringify(data.config, null, 2);
        } else {
          alert('No valid config to copy. Generate a config first.');
        }
      } catch {
        alert('Could not parse the generate result.');
      }
    }

    async function generateConfig() {
      const sourceFile = document.getElementById('generateSourceFile').value;
      const fileType = document.getElementById('generateFileType').value;
      const targetRepository = document.getElementById('generateTargetRepo').value;
      const resultDiv = document.getElementById('generateResult');
      const fieldsDiv = document.getElementById('sourceFieldsResult');
      
      resultDiv.textContent = 'Loading...';
      resultDiv.className = 'result';
      fieldsDiv.textContent = 'Loading...';
      fieldsDiv.className = 'result';

      try {
        const response = await fetch(`${API_BASE}/generate/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sourceFile, fileType, targetRepository })
        });
        const data = await response.json();
        
        // Show config
        resultDiv.textContent = JSON.stringify(data.config, null, 2);
        resultDiv.className = response.ok ? 'result success' : 'result error';
        
        // Show source info
        if (data.sourceInfo) {
          fieldsDiv.innerHTML = `<strong>Fields:</strong> ${data.sourceInfo.fields.join(', ')}\n<strong>Records:</strong> ${data.sourceInfo.recordCount}\n\n<strong>Sample:</strong>\n${JSON.stringify(data.sourceInfo.sampleRecords, null, 2)}`;
          fieldsDiv.className = 'result success';
        }
      } catch (err) {
        resultDiv.textContent = 'Error: ' + err.message;
        resultDiv.className = 'result error';
        fieldsDiv.textContent = '';
      }
    }

    function parseSourceData(sourceFile, sourceType) {
      if (sourceType === 'csv') {
        const lines = sourceFile.trim().split('\n');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim());
          const record = {};
          headers.forEach((h, i) => record[h] = values[i] || '');
          return record;
        });
      } else {
        const parsed = JSON.parse(sourceFile);
        if (Array.isArray(parsed)) return parsed;
        for (const key of Object.keys(parsed)) {
          if (Array.isArray(parsed[key])) return parsed[key];
        }
        return [parsed];
      }
    }

    function renderRecordCard(record, isOutput = false) {
      const card = document.createElement('div');
      card.className = 'record-card' + (isOutput && record._meta ? (record._meta.success ? ' success' : ' error') : '');
      
      if (isOutput) {
        card.innerHTML = `<div class="id">ID: ${record.id} <span style="color:#888">(${record.type})</span></div>`;
        for (const [key, value] of Object.entries(record.data || {})) {
          card.innerHTML += `<div class="field"><span class="field-name">${key}:</span><span class="field-value">${value}</span></div>`;
        }
        if (record._meta) {
          card.innerHTML += `<div class="meta">Index: ${record._meta.sourceIndex} | Success: ${record._meta.success}${record._meta.errors ? ' | Errors: ' + record._meta.errors.join(', ') : ''}</div>`;
        }
      } else {
        for (const [key, value] of Object.entries(record)) {
          card.innerHTML += `<div class="field"><span class="field-name">${key}:</span><span class="field-value">${value}</span></div>`;
        }
      }
      
      return card;
    }

    function toggleRawView() {
      showRawView = !showRawView;
      updateExecuteDisplay();
    }

    function updateExecuteDisplay() {
      const comparisonView = document.getElementById('comparisonView');
      const rawView = document.getElementById('executeResultRaw');
      const summaryBar = document.getElementById('summaryBar');
      
      if (!lastExecuteResult || !lastExecuteResult.valid) {
        comparisonView.style.display = 'none';
        summaryBar.style.display = 'none';
        rawView.style.display = showRawView ? 'block' : 'none';
        return;
      }
      
      if (showRawView) {
        comparisonView.style.display = 'none';
        rawView.style.display = 'block';
        rawView.textContent = JSON.stringify(lastExecuteResult, null, 2);
        rawView.className = 'result success';
      } else {
        comparisonView.style.display = 'grid';
        rawView.style.display = 'none';
      }
      summaryBar.style.display = 'flex';
    }

    async function executeConfig() {
      const configText = document.getElementById('executeConfig').value;
      const sourceFile = document.getElementById('executeSourceFile').value;
      const errorDiv = document.getElementById('executeResultError');
      const inputRecordsDiv = document.getElementById('inputRecords');
      const outputRecordsDiv = document.getElementById('outputRecords');
      
      errorDiv.style.display = 'none';
      document.getElementById('comparisonView').style.display = 'none';
      document.getElementById('summaryBar').style.display = 'none';

      try {
        const config = JSON.parse(configText);
        const response = await fetch(`${API_BASE}/execute/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config, sourceFile })
        });
        const data = await response.json();
        lastExecuteResult = data;
        
        if (!data.valid) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = 'Validation Errors:\n' + data.errors.map(e => `  ${e.path}: ${e.message}`).join('\n');
          return;
        }
        
        // Update summary
        document.getElementById('statTotal').textContent = data.summary.totalRecords;
        document.getElementById('statSuccess').textContent = data.summary.successfulImports;
        document.getElementById('statFailed').textContent = data.summary.failedImports;
        document.getElementById('statRepo').textContent = data.summary.targetRepository;
        
        // Parse source for comparison
        const sourceRecords = parseSourceData(sourceFile, config.sourceType);
        
        // Render input records
        inputRecordsDiv.innerHTML = '';
        sourceRecords.forEach(record => {
          inputRecordsDiv.appendChild(renderRecordCard(record, false));
        });
        
        // Render output records
        outputRecordsDiv.innerHTML = '';
        data.records.forEach(record => {
          outputRecordsDiv.appendChild(renderRecordCard(record, true));
        });
        
        showRawView = false;
        updateExecuteDisplay();
        
      } catch (err) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Error: ' + err.message;
      }
    }
  </script>
</body>
</html>
