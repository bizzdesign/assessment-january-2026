<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Import - Assessment API Tester</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; }
    h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
    h2 { margin-top: 30px; }
    h3 { margin: 10px 0; font-size: 14px; color: #555; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; font-family: monospace; }
    textarea { height: 120px; resize: vertical; }
    button { margin-top: 10px; padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; margin-right: 10px; }
    button:hover { background: #555; }
    .result { margin-top: 10px; padding: 12px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 12px; overflow-x: auto; max-height: 300px; overflow-y: auto; }
    .error { background: #fee; color: #c00; }
    .success { background: #efe; }
    hr { margin: 40px 0; border: none; border-top: 2px solid #ddd; }
    .row { display: flex; gap: 15px; }
    .row > * { flex: 1; }
    
    /* Comparison layout */
    .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
    .comparison-panel { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #fafafa; max-height: 500px; overflow-y: auto; }
    .comparison-panel h3 { margin-top: 0; padding-bottom: 8px; border-bottom: 1px solid #ddd; position: sticky; top: 0; background: #fafafa; }
    .record-card { background: white; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; margin-bottom: 10px; font-family: monospace; font-size: 11px; }
    .record-card:last-child { margin-bottom: 0; }
    .record-card .id { font-weight: bold; color: #333; margin-bottom: 5px; font-size: 12px; }
    .record-card .field { display: flex; margin: 2px 0; }
    .record-card .field-name { color: #666; min-width: 140px; flex-shrink: 0; }
    .record-card .field-value { color: #000; word-break: break-all; }
    .record-card.success { border-left: 3px solid #4a4; }
    .record-card.error { border-left: 3px solid #a44; }
    .meta { font-size: 10px; color: #888; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd; }
    
    .summary-bar { background: #333; color: white; padding: 10px 15px; border-radius: 4px; margin-bottom: 15px; display: flex; justify-content: space-around; }
    .summary-bar .stat { text-align: center; }
    .summary-bar .stat-value { font-size: 20px; font-weight: bold; }
    .summary-bar .stat-label { font-size: 11px; opacity: 0.8; }

    .schema-info { background: #f0f0f0; padding: 10px; border-radius: 4px; font-size: 12px; margin-top: 10px; }
    .schema-info code { background: #ddd; padding: 2px 4px; border-radius: 2px; }
  </style>
</head>
<body>
  <h1>Order Import - Assessment API Tester</h1>
  <p>Transform order data from various source formats into our standardized order schema.</p>

  <div class="schema-info">
    <strong>Target Order Schema:</strong><br>
    Required: <code>orderId</code><br>
    Optional: <code>customerId</code>, <code>customerEmail</code>, <code>customerName</code>, <code>totalAmount</code> (cents), <code>currency</code>, <code>status</code>, <code>itemCount</code>, <code>shippingAddress</code>, <code>shippingCity</code>, <code>shippingCountry</code>, <code>createdAt</code>, <code>updatedAt</code>, <code>notes</code>
  </div>

  <h2>1. Generate Mapping Config</h2>
  <p>Select a sample order file and generate a mapping configuration using the LLM.</p>
  
  <div class="row">
    <div>
      <label>Load Sample File:</label>
      <select id="sampleFileSelect" onchange="loadSampleFile()">
        <option value="">-- Select a sample order file --</option>
        <option value="ecommerce-orders.csv">ecommerce-orders.csv (simple CSV)</option>
        <option value="shopify-export.json">shopify-export.json (nested JSON)</option>
        <option value="legacy-system.csv">legacy-system.csv (legacy codes)</option>
        <option value="woocommerce-export.json">woocommerce-export.json (nested with wrapper)</option>
        <option value="pos-transactions.csv">pos-transactions.csv (POS system)</option>
      </select>
    </div>
    <div>
      <label>File Type:</label>
      <select id="generateFileType">
        <option value="csv">CSV</option>
        <option value="json">JSON</option>
      </select>
    </div>
  </div>

  <label>Source File Content:</label>
  <textarea id="generateSourceFile" placeholder="Paste your CSV or JSON order file here..."></textarea>
  
  <button onclick="generateConfig()">Generate Config</button>
  <button onclick="copyConfigToExecute()">Copy to Execute â†“</button>
  
  <div class="row" style="margin-top: 15px;">
    <div>
      <h3>Generated Config</h3>
      <div id="generateResult" class="result">Response will appear here...</div>
    </div>
    <div>
      <h3>Detected Source Fields</h3>
      <div id="sourceFieldsResult" class="result">Fields will appear here...</div>
    </div>
  </div>

  <hr>

  <h2>2. Execute Mapping</h2>
  <p>Apply the mapping configuration to transform source orders into standardized format.</p>

  <div class="row">
    <div>
      <label>Mapping Config (JSON):</label>
      <textarea id="executeConfig" style="height: 200px;">{
  "name": "ecommerce-order-import",
  "sourceType": "csv",
  "idField": "order_id",
  "fieldMappings": [
    { "sourceField": "customer_id", "targetField": "customerId" },
    { "sourceField": "customer_email", "targetField": "customerEmail" },
    { "sourceField": "customer_name", "targetField": "customerName" },
    { "sourceField": "total_usd", "targetField": "totalAmount", "transform": "number" },
    { "sourceField": "order_status", "targetField": "status", "transform": "lowercase" },
    { "sourceField": "item_count", "targetField": "itemCount", "transform": "number" },
    { "sourceField": "created_date", "targetField": "createdAt" }
  ],
  "options": { "skipEmptyFields": true, "validateRequired": false }
}</textarea>
    </div>
    <div>
      <label>Source File Content:</label>
      <textarea id="executeSourceFile" style="height: 200px;" placeholder="Paste your order file here..."></textarea>
    </div>
  </div>

  <button onclick="executeConfig()">Execute Mapping</button>
  <button onclick="toggleRawView()">Toggle Raw JSON</button>

  <div id="executeResultContainer">
    <div id="summaryBar" class="summary-bar" style="display: none;">
      <div class="stat"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Orders</div></div>
      <div class="stat"><div class="stat-value" id="statSuccess">0</div><div class="stat-label">Successful</div></div>
      <div class="stat"><div class="stat-value" id="statFailed">0</div><div class="stat-label">Failed</div></div>
    </div>
    
    <div id="comparisonView" class="comparison" style="display: none;">
      <div class="comparison-panel">
        <h3>Source Orders (Input)</h3>
        <div id="inputRecords"></div>
      </div>
      <div class="comparison-panel">
        <h3>Standardized Orders (Output)</h3>
        <div id="outputRecords"></div>
      </div>
    </div>
    
    <div id="executeResultRaw" class="result" style="display: none;">Response will appear here...</div>
    <div id="executeResultError" class="result error" style="display: none;"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    let lastExecuteResult = null;
    let showRawView = false;

    const SAMPLE_FILES = {
      'ecommerce-orders.csv': {
        fileType: 'csv',
        content: `order_id,customer_id,customer_email,customer_name,total_usd,order_status,item_count,created_date
ORD-10001,CUST-501,alice@example.com,Alice Johnson,149.99,shipped,3,2026-01-15T10:30:00Z
ORD-10002,CUST-502,bob.smith@email.org,Bob Smith,79.50,pending,1,2026-01-16T14:22:00Z
ORD-10003,CUST-501,alice@example.com,Alice Johnson,299.00,delivered,5,2026-01-10T09:15:00Z
ORD-10004,CUST-503,charlie@mail.net,Charlie Brown,45.99,processing,2,2026-01-17T16:45:00Z
ORD-10005,CUST-504,diana.prince@amazon.com,Diana Prince,599.99,confirmed,1,2026-01-18T11:00:00Z`
      },
      'shopify-export.json': {
        fileType: 'json',
        content: `[
  {
    "name": "#1001",
    "email": "john.doe@gmail.com",
    "financial_status": "paid",
    "fulfillment_status": "fulfilled",
    "total": "89.99",
    "currency": "USD",
    "created_at": "2026-01-20T08:30:00-05:00",
    "customer": { "id": 12345, "first_name": "John", "last_name": "Doe" },
    "line_items_count": 2,
    "shipping_address": { "city": "New York", "country": "US", "address1": "123 Main St" }
  },
  {
    "name": "#1002",
    "email": "jane.smith@yahoo.com",
    "financial_status": "pending",
    "fulfillment_status": null,
    "total": "249.50",
    "currency": "USD",
    "created_at": "2026-01-21T15:45:00-05:00",
    "customer": { "id": 12346, "first_name": "Jane", "last_name": "Smith" },
    "line_items_count": 4,
    "shipping_address": { "city": "Los Angeles", "country": "US", "address1": "456 Oak Ave" }
  }
]`
      },
      'legacy-system.csv': {
        fileType: 'csv',
        content: `ORDER_NUM,CUST_CODE,EMAIL_ADDR,AMOUNT_CENTS,STATUS_CD,SHIP_CITY,SHIP_COUNTRY,ORDER_DT,NOTES
2026-0001,C100,customer1@legacy.com,15000,SHP,London,GB,20260115,Express shipping requested
2026-0002,C101,customer2@legacy.com,8999,PND,Manchester,GB,20260116,
2026-0003,C102,customer3@legacy.com,45000,DLV,Birmingham,GB,20260112,Gift wrap included
2026-0004,C100,customer1@legacy.com,22500,CNF,London,GB,20260118,Second order this month
2026-0005,C103,customer4@legacy.com,6750,CNC,Leeds,GB,20260114,Cancelled by customer`
      },
      'woocommerce-export.json': {
        fileType: 'json',
        content: `{
  "orders": [
    {
      "id": 5001,
      "status": "processing",
      "date_created": "2026-01-22T09:00:00",
      "total": "175.00",
      "currency": "EUR",
      "billing": { "email": "hans.mueller@example.de", "first_name": "Hans", "last_name": "Mueller" },
      "shipping": { "city": "Berlin", "country": "DE", "address_1": "Hauptstrasse 10" },
      "line_items": [ { "name": "Product A", "quantity": 2 }, { "name": "Product B", "quantity": 1 } ]
    },
    {
      "id": 5002,
      "status": "completed",
      "date_created": "2026-01-21T14:30:00",
      "total": "59.99",
      "currency": "EUR",
      "billing": { "email": "marie.dupont@example.fr", "first_name": "Marie", "last_name": "Dupont" },
      "shipping": { "city": "Paris", "country": "FR", "address_1": "15 Rue de la Paix" },
      "line_items": [ { "name": "Product C", "quantity": 1 } ]
    }
  ]
}`
      },
      'pos-transactions.csv': {
        fileType: 'csv',
        content: `txn_ref,register_id,buyer_email,buyer_phone,sale_total,tax_amount,payment_type,txn_status,txn_time
POS-20260125-001,REG-03,walk.in@store.com,555-0101,42.99,3.44,card,complete,2026-01-25T10:15:33Z
POS-20260125-002,REG-01,member@loyalty.com,555-0202,128.50,10.28,card,complete,2026-01-25T11:30:00Z
POS-20260125-003,REG-02,walk.in@store.com,555-0303,15.99,1.28,cash,complete,2026-01-25T12:45:22Z
POS-20260125-004,REG-03,vip@customer.org,555-0404,350.00,28.00,card,refunded,2026-01-25T14:00:00Z
POS-20260125-005,REG-01,member@loyalty.com,555-0505,67.25,5.38,card,complete,2026-01-25T15:20:10Z`
      }
    };

    function loadSampleFile() {
      const select = document.getElementById('sampleFileSelect');
      const fileName = select.value;
      if (fileName && SAMPLE_FILES[fileName]) {
        const sample = SAMPLE_FILES[fileName];
        document.getElementById('generateSourceFile').value = sample.content;
        document.getElementById('executeSourceFile').value = sample.content;
        document.getElementById('generateFileType').value = sample.fileType;
      }
    }

    function copyConfigToExecute() {
      const result = document.getElementById('generateResult').textContent;
      try {
        const config = JSON.parse(result);
        if (config && config.name && config.fieldMappings && !config._placeholder) {
          document.getElementById('executeConfig').value = JSON.stringify(config, null, 2);
          const sourceFile = document.getElementById('generateSourceFile').value;
          if (sourceFile) {
            document.getElementById('executeSourceFile').value = sourceFile;
          }
        } else {
          alert('No valid config to copy. Generate a config first.');
        }
      } catch {
        alert('Could not parse the generate result.');
      }
    }

    async function generateConfig() {
      const sourceFile = document.getElementById('generateSourceFile').value;
      const fileType = document.getElementById('generateFileType').value;
      const resultDiv = document.getElementById('generateResult');
      const fieldsDiv = document.getElementById('sourceFieldsResult');
      
      resultDiv.textContent = 'Loading...';
      resultDiv.className = 'result';
      fieldsDiv.textContent = 'Loading...';
      fieldsDiv.className = 'result';

      try {
        const response = await fetch(`${API_BASE}/generate/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sourceFile, fileType })
        });
        const data = await response.json();
        
        resultDiv.textContent = JSON.stringify(data.config, null, 2);
        resultDiv.className = response.ok ? 'result success' : 'result error';
        
        if (data.sourceInfo) {
          fieldsDiv.innerHTML = `<strong>Fields:</strong> ${data.sourceInfo.fields.join(', ')}\n<strong>Records:</strong> ${data.sourceInfo.recordCount}\n\n<strong>Sample:</strong>\n${JSON.stringify(data.sourceInfo.sampleRecords, null, 2)}`;
          fieldsDiv.className = 'result success';
        }
      } catch (err) {
        resultDiv.textContent = 'Error: ' + err.message;
        resultDiv.className = 'result error';
        fieldsDiv.textContent = '';
      }
    }

    function parseSourceData(sourceFile, sourceType) {
      if (sourceType === 'csv') {
        const lines = sourceFile.trim().split('\n');
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim());
          const record = {};
          headers.forEach((h, i) => record[h] = values[i] || '');
          return record;
        });
      } else {
        const parsed = JSON.parse(sourceFile);
        if (Array.isArray(parsed)) return parsed;
        for (const key of Object.keys(parsed)) {
          if (Array.isArray(parsed[key])) return parsed[key];
        }
        return [parsed];
      }
    }

    function renderRecordCard(record, isOutput = false) {
      const card = document.createElement('div');
      
      if (isOutput) {
        const orderData = record.order || {};
        card.className = 'record-card' + (record._success ? ' success' : ' error');
        card.innerHTML = `<div class="id">Order: ${orderData.orderId || 'unknown'}</div>`;
        for (const [key, value] of Object.entries(orderData)) {
          if (key === 'orderId') continue;
          const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
          card.innerHTML += `<div class="field"><span class="field-name">${key}:</span><span class="field-value">${displayValue}</span></div>`;
        }
        card.innerHTML += `<div class="meta">Index: ${record._sourceIndex} | Success: ${record._success}${record._errors ? ' | Errors: ' + record._errors.join(', ') : ''}</div>`;
      } else {
        card.className = 'record-card';
        for (const [key, value] of Object.entries(record)) {
          const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
          card.innerHTML += `<div class="field"><span class="field-name">${key}:</span><span class="field-value">${displayValue}</span></div>`;
        }
      }
      
      return card;
    }

    function toggleRawView() {
      showRawView = !showRawView;
      updateExecuteDisplay();
    }

    function updateExecuteDisplay() {
      const comparisonView = document.getElementById('comparisonView');
      const rawView = document.getElementById('executeResultRaw');
      const summaryBar = document.getElementById('summaryBar');
      
      if (!lastExecuteResult || !lastExecuteResult.valid) {
        comparisonView.style.display = 'none';
        summaryBar.style.display = 'none';
        rawView.style.display = showRawView ? 'block' : 'none';
        return;
      }
      
      if (showRawView) {
        comparisonView.style.display = 'none';
        rawView.style.display = 'block';
        rawView.textContent = JSON.stringify(lastExecuteResult, null, 2);
        rawView.className = 'result success';
      } else {
        comparisonView.style.display = 'grid';
        rawView.style.display = 'none';
      }
      summaryBar.style.display = 'flex';
    }

    async function executeConfig() {
      const configText = document.getElementById('executeConfig').value;
      const sourceFile = document.getElementById('executeSourceFile').value;
      const errorDiv = document.getElementById('executeResultError');
      const inputRecordsDiv = document.getElementById('inputRecords');
      const outputRecordsDiv = document.getElementById('outputRecords');
      
      errorDiv.style.display = 'none';
      document.getElementById('comparisonView').style.display = 'none';
      document.getElementById('summaryBar').style.display = 'none';

      try {
        const config = JSON.parse(configText);
        const response = await fetch(`${API_BASE}/execute/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config, sourceFile })
        });
        const data = await response.json();
        lastExecuteResult = data;
        
        if (!data.valid) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = 'Validation Errors:\n' + data.errors.map(e => `  ${e.path}: ${e.message}`).join('\n');
          return;
        }
        
        document.getElementById('statTotal').textContent = data.summary.totalRecords;
        document.getElementById('statSuccess').textContent = data.summary.successfulImports;
        document.getElementById('statFailed').textContent = data.summary.failedImports;
        
        const sourceRecords = parseSourceData(sourceFile, config.sourceType);
        
        inputRecordsDiv.innerHTML = '';
        sourceRecords.forEach(record => {
          inputRecordsDiv.appendChild(renderRecordCard(record, false));
        });
        
        outputRecordsDiv.innerHTML = '';
        data.orders.forEach(record => {
          outputRecordsDiv.appendChild(renderRecordCard(record, true));
        });
        
        showRawView = false;
        updateExecuteDisplay();
        
      } catch (err) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Error: ' + err.message;
      }
    }
  </script>
</body>
</html>
